
# Installation

k2 supports CUDA as well as CPU. To get the full benefit from k2,
we recommend that you have installed CUDA on your system before
installing k2. CUDA 10.1 and 10.2 are known to work. PyTorch
is also needed. `torch 1.6.0` and `torch 1.7.0` are known to work.


## Install from Pre-built wheel packages

There are two ways to install k2 from pre-built wheel packages.

### (1) From PyPI using `pip install k2`

  The wheel packages on PyPI are built using torch==1.6.0+cu101 on Ubuntu 18.04.
  If you are using other Linux systems, the pre-built wheel packages may NOT
  work on your system, please install k2 from source in this case.

  **CAUTION**: k2 is still under active development and we are trying to keep
  the packages on PyPI up to date. If you want to try the latest version, please
  install k2 from source.

### (2) From GitHub actions

We have set up GitHub actions to build wheel packages for every pullrequest.
They can be downloaded from the following URL:

https://github.com/k2-fsa/k2/actions?query=workflow%3Abuild

Please click the above URL and select the pullrequest from which you
want to download the pre-built wheel package. The environment information
for building the wheel packages is encoded in the filename. For example,
`gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04` means this wheel
package is built using `GCC 6`, `CUDA toolkit 10.2`, `torch 1.7.0`,
`Python 3.8` and `Ubuntu 18.04`.

After downloading, you will get a `zip` file, e.g.,
`gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04.zip`.
After `unzip gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04.zip`,
you will obtain `k2-0.1.1+cu102.dev20201124-cp38-cp38-linux_x86_64.whl`,
which can be installed using:

```bash
pip install ./k2-0.1.1+cu102.dev20201124-cp38-cp38-linux_x86_64.whl
```

**NOTE**: After `unzip`, you may get a `*.whl` with a different filename from
the above one.

The pre-built packages generated by GitHub actions are available for 90 days
after creation.

## Install from source

Before compiling k2, some preparation work has to be done:

- Have a compiler supporting at least c++14, e.g., GCC >= 5.0, Clang >= 3.4.
- Install CMake. CMake 3.11.0 and 3.18.0 are known to work.
- Install Python3. Python 3.6, 3.7 and 3.8 are known to work.
- Install PyTorch. PyTorch 1.6 and 1.7 are known to work.
- Install CUDA toolkit. CUDA 10.1 and 10.2 are known to work.
- Install cuDNN. Please install a version that is compatible with the
  CUDA toolkit you are using.

After setting up the environment, we are ready to build k2:

```bash
git clone https://github.com/k2-fsa/k2.git
cd k2
mkdir build
cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make _k2
cd ..
pip3 install wheel twine
./scripts/build_pip.sh

# Have a look at the `dist/` directory.
```

You will find the wheel file in the `dist` directory, e.g.,
`dist/k2-0.1.1.dev20201125-cp38-cp38-linux_x86_64.whl`, which
can be installed with

```
pip install dist/k2-0.1.1.dev20201125-cp38-cp38-linux_x86_64.whl
```

**HINT**: You may get a wheel with a different filename.

You can run tests with

```bash
cd build
make -j
make test
```

To run tests in parallel

```bash
cd build
make -j
ctest --parallel <JOBNUM>
```

If Valgrind is installed, you can check heap corruptions and memory leaks by

```bash
cd build
make -j
ctest -R <TESTNAME> -D ExperimentalMemCheck
```
