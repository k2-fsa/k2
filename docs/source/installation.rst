
Installation
============

.. HINT::

  Neither sudo priviledges nor GPU is required to build, install, and run k2.

Dependencies installation
-------------------------

k2 supports CUDA as well as CPU. To get the full benefit from k2,
we recommend that you have installed CUDA on your system before
installing k2. CUDA 10.1 and 10.2 are known to work. PyTorch
is also needed. `torch 1.5.x`, `torch 1.6.0`, `torch 1.7.x`, and
`torch 1.8.0` are known to work.

If you use pip to install torch, make sure the torch version
you install is compatible with the CUDA toolkit you are using.
For example, if your local CUDA toolkit version is 10.1, and
you want to install `torch 1.7.1`, you should install it with::

  pip install torch==1.7.1+cu101 -f https://download.pytorch.org/whl/torch_stable.html

If you use conda to manage packages, you can install those
dependencies with::

  conda create -n k2 python=3.7
  conda activate k2
  conda install pytorch==1.7.1 cudatoolkit=10.1 -c pytorch

To install other versions of torch, please check the following URLs:

- `<https://pytorch.org/get-started/locally/>`_

- `<https://pytorch.org/get-started/previous-versions/>`_

.. HINT::

    If you install k2 from pre-built wheel packages, neither do you need
    a GPU nor need to install CUDA toolkit. k2 is ready to run with a CPU.
    However, you still need to install PyTorch with CUDA support.


Install k2 from pre-built wheel packages
----------------------------------------

There are three ways to install k2 from pre-built wheel packages.

From `<https://k2-fsa.org/nightly>`_
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can find a list of nightly built wheels at `<https://k2-fsa.org/nightly/>`_.
They are built using PyTorch 1.7.1 and support a combination of Python 3.6,
3.7, 3.8, and 3.9 with CUDA 10.1, 10.2, 11.0, and 11.1.

The following commands install k2 with different CUDA versions:

.. code-block:: bash

  # Install k2 0.3.3 with CUDA 10.2 built on 20210209
  pip install k2==0.3.3+cu102.dev20210209 -f https://k2-fsa.org/nightly/

  # Install k2 0.3.3 with CUDA 11.0 built on 20210209
  pip install k2==0.3.3+cu110.dev20210209 -f https://k2-fsa.org/nightly/

  # Install k2 0.3.3 with CUDA 10.1 built on 20210209
  pip install k2==0.3.3.dev20210209 -f https://k2-fsa.org/nightly/

.. HINT::

  ``cu102`` and ``cu110`` indicate CUDA 10.2 and 11.0, respectively.
  The default CUDA version is 10.1.

  There is no need to specify which Python version to use. ``pip``
  will figure it out for you automagically.

  This is the recommended approach to install the **latest** k2 from 
  pre-built wheels using ``pip``.

.. CAUTION::

  You have to use the option ``-f https://k2-fsa.org/nightly/``
  in ``pip install``. It is ``https``, not ``http``.

From PyPI
~~~~~~~~~

.. code-block::

  pip install --pre k2

The wheel packages on PyPI are built using `torch==1.7.1+cu101` on Ubuntu 18.04.
If you are using other Linux systems or a different PyTorch version,
the pre-built wheel packages may NOT work on your system, please install
k2 from source in this case.

.. CAUTION::

    k2 is still under active development and we are trying to keep
    the packages on PyPI up to date. Please use ``--pre`` in ``pip install``.

    If you want to try the latest version, please refer to
    :ref:`install k2 from source`.

From GitHub actions
~~~~~~~~~~~~~~~~~~~

We have set up GitHub actions to build wheel packages for every pullrequest.
They can be downloaded from the following URL:

`<https://github.com/k2-fsa/k2/actions?query=workflow%3Abuild>`_

Please click the above URL and select the pullrequest from which you
want to download the pre-built wheel package. The environment information
for building the wheel packages is encoded in the filename. For example,
`gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04` means this wheel
package is built using `GCC 6`, `CUDA toolkit 10.2`, `torch 1.7.0`,
`Python 3.8` and `Ubuntu 18.04`.

After downloading, you will get a `zip` file, e.g.,
`gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04.zip`.
After `unzip gcc-6-cuda-10.2-torch-1.7.0-python-3.8-ubuntu-18.04.zip`,
you will obtain `k2-0.1.1+cu102.dev20201124-cp38-cp38-linux_x86_64.whl`,
which can be installed using::

  pip install ./k2-0.1.1+cu102.dev20201124-cp38-cp38-linux_x86_64.whl

.. NOTE::

  After `unzip`, you may get a `*.whl` with a different filename from
  the above one.

The pre-built packages generated by GitHub actions are available for 90 days
after creation.

.. _install k2 from source:

Install k2 from source
----------------------

Before compiling k2, some preparation work has to be done:

- Have a compiler supporting at least C++14, e.g., GCC >= 5.0, Clang >= 3.4.
- Install CMake. CMake 3.11.0 and 3.18.0 are known to work.
- Install Python3. Python 3.6, 3.7, 3.8, and 3.9 are known to work.
- Install PyTorch. Pytorch 1.5.x, 1.6.0, 1.7.x, and 1.8.0 are known to work.
- Install CUDA toolkit. CUDA 10.1, 10.2, 11.0, and 11.1 are known to work.
- Install cuDNN. Please install a version that is compatible with the
  CUDA toolkit you are using.

.. NOTE::

  We need NVCC to build k2, if you use conda to install CUDA toolkit,
  you may need to install `nvcc_linux-64` or `cudatoolkit-dev` as well since the
  default installation of CUDA toolkit in conda did not include NVCC.
  However, `nvcc_linux-64` or `cudatoolkit-dev` may not work well on all platforms,
  so it's better if you can install CUDA toolkit using a normal way instead of
  using conda if you want to build k2 from source.)

After setting up the environment, we are ready to build k2::

  git clone https://github.com/k2-fsa/k2.git
  cd k2
  mkdir build
  cd build
  cmake -DCMAKE_BUILD_TYPE=Release ..
  # If you installed cudatoolkit using conda install -y -c nvidia cudatoolkit=X cudnn=Y,
  # source the conda environemt and change the cmake command to:
  # cmake -DCUDNN_LIBRARY_PATH=$(find $CONDA_PREFIX -name libcudnn.so) -DCUDNN_INCLUDE_PATH=$CONDA_PREFIX/include/ -DCMAKE_BUILD_TYPE=Release ..
  make _k2
  cd ..
  pip3 install wheel twine
  ./scripts/build_pip.sh

  # Have a look at the `dist/` directory.

You will find the wheel file in the `dist` directory, e.g.,
`dist/k2-0.1.1.dev20201125-cp38-cp38-linux_x86_64.whl`, which
can be installed with::

  pip install dist/k2-0.1.1.dev20201125-cp38-cp38-linux_x86_64.whl

.. HINT::

  You may get a wheel with a different filename.

.. Note::

  [For developers]

  If you are developing k2, you don't need to install k2 to use its Python APIs!
  All you need to do is to setup the ``PYTHONPATH`` environment variable so that
  Python can find where k2 resides.

  k2 contains two parts. The first part consists of pure Python files that are in
  ``k2_source_tree/k2/python/k2``. The second part is the C++ part, which has been
  compiled into a bunch of shared libraries that can be invoked from Python. These
  libraries are saved in `k2_build_tree/build/lib`.

  If you set ``PYTHONPATH`` to the following values:

  .. code-block::

    export PYTHONPATH=/path/to/k2/k2/python:$PYTHONPATH
    export PYTHONPATH=/path/to/k2/build/lib:$PYTHONPATH

  After ``PYTHONPATH`` is set, you can run:

  .. code-block::

    python3 -m k2.version
    python3 -c 'import k2; print(k2.__file__)'
    python3 -c 'import _k2; print(_k2.__file__)'

  Whenver you change some files in ``k2/python/k2``, it comes into effect immediately
  without uninstalling and installing operations.

  Whenever you modify some `*.cu` files, it is also available after issuing ``make _k2``
  without any installation effort.


To run tests, you have to install the following requirements first::

  sudo apt-get install graphviz
  cd k2
  pip3 install -r ./requirements.txt

You can run tests with::

  cd build
  make -j
  make test

To run tests in parallel::

  cd build
  make -j
  ctest --output-on-failure --parallel <JOBNUM>

If `valgrind` is installed, you can check heap corruptions and memory leaks by::

  cd build
  make -j
  ctest --output-on-failure -R <TESTNAME> -D ExperimentalMemCheck

.. HINT::

  You can install `valgrind` with `sudo apt-get install valgrind`
  on Ubuntu.

Reporting issues
----------------

If you encounter any errors while using k2 after installation, please
create an issue `on GitHub <https://github.com/k2-fsa/k2/issues/new>`_
and tell us your current environment by posting the output of the following
two commands::

  python3 -m k2.version
  python3 -m torch.utils.collect_env
